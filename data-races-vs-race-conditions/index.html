
<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://pantos9000.github.io/js/theme.min.js" integrity="sha384-pb++s6uBRKaQv+iAXpgA/H3IlpLZdO14tTwuCI7uXmz4aaZdByoCcM+6BhynMq/1"></script>
  <link rel="stylesheet" href="https://pantos9000.github.io/abridge.css?h=fd19da75e81a79102afd" />
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="base" content="https://pantos9000.github.io" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#333333" />
  <meta name="msapplication-TileColor" content="#333333" />
  <link rel="manifest" href="https://pantos9000.github.io/favicon/manifest.json" />
  <link rel="mask-icon" href="https://pantos9000.github.io/favicon/safari-pinned-tab.svg" color="#5bbad5" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://pantos9000.github.io/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="https://pantos9000.github.io/favicon/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="https://pantos9000.github.io/favicon/favicon-16x16.png" />
  <meta name="robots" content="index, follow" />
  <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <title>Data Races vs Race Conditions | Pantos' Periphrases</title>
  <meta name="author" content="Pantos" />
  <meta name="copyright" content="Pantos&#x27; Periphrases" />
  <meta name="description" content="Ideas that use an unnecessarily large number of words to express" />
  <link rel="canonical" href="https://pantos9000.github.io/data-races-vs-race-conditions/" />
  <meta name="keywords" content="rust, linux" />
  <script defer src="https://pantos9000.github.io/js/abridge.min.js?h=f0dd8dfd4cea819cfbc9" integrity="sha384-Zxtl536qNH4+tuZDSSLJWOtMLL/T5AxeD+unOQyqtvZD9RYA/CYxDZrYYC0vGIg+"></script>
  <noscript><link rel="stylesheet" href="https://pantos9000.github.io/nojs.css" /></noscript>
</head>
<body>
  <header>
    <nav>
      <div><big><a href="https://pantos9000.github.io" title="Pantos&#x27; Periphrases"><font color="#09f">P</font>antos` <font color="#09f">P</font>eriphrases</a></big></div>
      <div>

        <div>
          <ul><li><a class="s110" href="https://pantos9000.github.io/archive/"> Posts </a></li><li><a class="s110" href="https://pantos9000.github.io/tags/"> Tags </a></li><li><a class="s110" href="https://pantos9000.github.io/about/"> About </a></li><li><i type="reset" id="mode" class="js svgs adjust"></i></ul>
        </div>

        <div>
          <div>
            <form autocomplete=off class="js" name="goSearch" id="searchbox">
              <div class="searchd">
                <input id="searchinput" type="text" placeholder="Search" title="Search" />
                <button type="submit" title="Search" class="svgs svgm search"></button>
              </div>
              <div class="results"><div id="suggestions"></div></div>
            </form>
          </div>
        </div>

      </div>
    </nav>
    <div class="desc">Ideas that use an unnecessarily large number of words to express</div>
    <hr />
  </header>
  <main>
    <article>
      <h1><a href="https://pantos9000.github.io/data-races-vs-race-conditions/">Data Races vs Race Conditions</a></h1>

      <span class="s95"> Pantos <span class="rpad"></span> September 26, 2024 <span class="rpad"></span> #<a href="https://pantos9000.github.io/tags/data-race/">data race</a>  #<a href="https://pantos9000.github.io/tags/race-condition/">race condition</a>  #<a href="https://pantos9000.github.io/tags/threads/">threads</a>  #<a href="https://pantos9000.github.io/tags/multithreading/">multithreading</a> </span>

    


<p>I once had an &quot;aha&quot;-moment when realizing the difference between the different terms. I thought it
might be a good idea to write it down for reference.</p>
<h1 id="definitions">Definitions</h1>
<p>A <strong>data race</strong> occurs when two or more different threads access the same memory location, where at
least one of them is doing a write.</p>
<p>On the other hand, a <strong>race condition</strong> occurs when the observable outcome of a program is
depending on the timing of how the threads are scheduled.</p>
<p>These definitions clearly look different, but it really made <em>click</em> in my head only after I looked
at a few examples.</p>
<h1 id="a-first-example">A first example</h1>
<p>The following example is written in pseudocode.</p>
<p>Consider two threads accessing the same variable <code>x</code>:</p>
<pre data-lang="C" class="language-C z-code"><code class="language-C" data-lang="C"><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Thread 0
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    x <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span><span class="z-source z-c">
</span><span class="z-source z-c"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> ...
</span></span><span class="z-source z-c">
</span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Thread 1
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    x <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">2</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></code></pre>
<p>Depending on which thread is executed last, by the end of the program the variable <code>x</code> will be set
to either <code>1</code> or <code>2</code>, so we have a <strong>race condition</strong>. But both threads might also write to the
memory at the same time, which is a <strong>data race</strong>.</p>
<p>Usually you would not notice such a thing (like on <em>X86_64</em>), but imagine a software architecture
that does not atomically set the word, but might set the different bits in an arbitrary fashion.
Then one thread might set one bit, while the other sets another bit. We might end up with <code>0</code> or
even <code>3</code> as a result. This is one of the reasons why data races are considered
<strong>undefined behavior</strong> by several languages such as <code>C</code>, <code>C++</code> and <code>Rust</code>.</p>
<h1 id="a-fix-for-the-data-race">A fix for the Data Race</h1>
<p>A common thing to do when confronted with a multithreading problem is to throw mutexes at it. Let's
try this:</p>
<pre data-lang="C" class="language-C z-code"><code class="language-C" data-lang="C"><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Thread 0
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    mutex<span class="z-punctuation z-accessor z-c">.</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">lock</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    x <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    mutex<span class="z-punctuation z-accessor z-c">.</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">unlock</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span><span class="z-source z-c">
</span><span class="z-source z-c"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> ...
</span></span><span class="z-source z-c">
</span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Thread 1
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    mutex<span class="z-punctuation z-accessor z-c">.</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">lock</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    x <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">2</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    mutex<span class="z-punctuation z-accessor z-c">.</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">unlock</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></code></pre>
<p>We can easily see now that <code>x</code> can only be written to by one thread at a time, so we can't get a
<strong>data race</strong> anymore. But we still have the <strong>race condition</strong>, as the value of the variable still
depends on which thread locks the mutex first.</p>
<h1 id="a-workaround-for-the-race-condition">A workaround for the race condition</h1>
<p>Now there are different ways to fix race conditions, but in this very simple example, we can do
workarounds as ugly as we want, so here we go:</p>
<pre data-lang="C" class="language-C z-code"><code class="language-C" data-lang="C"><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Thread 0
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    x <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span><span class="z-source z-c">
</span><span class="z-source z-c"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> ...
</span></span><span class="z-source z-c">
</span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Thread 1
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    x <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></code></pre>
<p>Now both threads set <code>x</code> to the same value. This has the effect that it does not matter which
thread comes first and which comes last, the variable will in the end always be <code>1</code>. So we don't
have a <strong>race condition</strong> anymore.</p>
<p>But note that we again have a <strong>data race</strong>, as it does not matter which value is written.</p>
<h1 id="combining-both">Combining both</h1>
<p>You probably already guessed it by now - we can avoid both problems by combining both fixes:</p>
<pre data-lang="C" class="language-C z-code"><code class="language-C" data-lang="C"><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Thread 0
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    mutex<span class="z-punctuation z-accessor z-c">.</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">lock</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    x <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    mutex<span class="z-punctuation z-accessor z-c">.</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">unlock</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span><span class="z-source z-c">
</span><span class="z-source z-c"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> ...
</span></span><span class="z-source z-c">
</span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Thread 1
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    mutex<span class="z-punctuation z-accessor z-c">.</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">lock</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    x <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    mutex<span class="z-punctuation z-accessor z-c">.</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">unlock</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></code></pre>
<p>Of course this is not a real-world example, but it shows very nicely the differences of both
problems, and what it comes down to if you want to avoid them.</p>
<h1 id="sidenote-rust">Sidenote: Rust</h1>
<p>Note that in (safe) Rust, you cannot have <strong>data races</strong>, as the borrow checker does not let you borrow
a mutable reference to <code>x</code> while it is already mutably or immutably borrowed. So both threads are
not able to borrow the variable at the same time. You <em>must</em> either wrap it in a mutex or solve the issue
differently, e.g. by using atomic data types.</p>
<p>But just because you don't run into <strong>data races</strong> anymore does not mean that you can't have
<strong>race conditions</strong>.</p>

      <nav>
        <div>
          <a href="https://pantos9000.github.io/german-strings-in-rust/">&#8249; German Strings in Rust</a>
        </div>
        <div>
          <a href="https://pantos9000.github.io/how-safe-rust-avoids-aliasing/"> How safe rust avoids pointer aliasing &#8250;</a>
        </div>
      </nav>
    </article>

    <div class="sblock">
      <div class="blockdiv sticky">
        <a class="b s150" href="#">Index</a>
        <div>
          <a href="#definitions">Definitions</a>
        </div>
        <div>
          <a href="#a-first-example">A first example</a>
        </div>
        <div>
          <a href="#a-fix-for-the-data-race">A fix for the Data Race</a>
        </div>
        <div>
          <a href="#a-workaround-for-the-race-condition">A workaround for the race condition</a>
        </div>
        <div>
          <a href="#combining-both">Combining both</a>
        </div>
        <div>
          <a href="#sidenote-rust">Sidenote: Rust</a>
        </div>
      </div>
    </div>
  </main>
  <footer>
    <hr />
    <div class="c">
      <nav class="tpad"><div><a href="https://github.com/pantos9000/" target="_blank" title="Github"><i type="Button" class="svg github" title="Github"></i></a></div></nav>
      <nav class="vpad">
        <a class="rpad" href="https://pantos9000.github.io/about/"> About </a>
        <a class="rpad" href="https://pantos9000.github.io/privacy/"> Privacy </a>
        <a class="rpad" href="https://pantos9000.github.io/sitemap.xml" target="_blank"> Sitemap </a>
      </nav>
      <p class="s90"> &copy; <span id="year">2024</span> Pantos' Periphrases</p>
      <p class="s90">Powered by <a href="https://www.getzola.org/" target="_blank">Zola</a> & <a href="https://github.com/jieiku/abridge/" target="_blank">Abridge</a></p>
    </div>
  </footer><span class="topout">
<span class="topleft"> </span><a href="#" class="top" title="Back to Top"><i class="svgs svgh angu"></i></a>
</span>
</body>
</html>
